<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>쿠키쌓기</title>
    <script src="/phaser.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script> 
</head>
<body>
    <script type="text/javascript">
    class Example extends Phaser.Scene
    {
        constructor ()
        {
            super();
        }

        preload()//데이터를 불러 올 떄 사용하는 함수
        {
            this.load.image('rainbow', 'assets/rainbow.png'); 
            this.load.image('sky', 'assets/sky.png'); 
            this.load.image('ground', 'assets/platform.png'); 
            this.load.image('star', 'assets/star.png'); 
            this.load.image('bomb', 'assets/bomb.png');
            this.load.image('jumpPenguin', 'assets/jumpPenguin.png'); 
            this.load.image('bubblePenguin', 'assets/bubblePenguin.png');
            this.load.image('dummyPenguin', 'assets/penguin.png'); 
            this.load.spritesheet('dude', 'assets/dude.png', 
            {frameWidth: 32, frameHeight: 48 }); 
        }

        create()//처음 게임을 실행할 떄 수행되는 함수
        {   
            cursors = this.input.keyboard.createCursorKeys();
            this.sky = this.add.tileSprite(400, 300, 0, 0, 'sky').setScrollFactor(0, 0);

            const rainbowContainer = this.add.container(400, 300);
            const rainbow1 = this.physics.add.sprite(382, 0, 'rainbow');
            const rainbow2 = this.physics.add.sprite(-382, 0, 'rainbow');
            rainbowContainer.add([ rainbow1, rainbow2]);

            rainbow1.body.pushable = false;//안밀리게
            rainbow2.body.pushable = false;

            dummyPenguin = this.physics.add.sprite(400, 550, 'dummyPenguin').setScale(1/6).setImmovable();
            
            bubblePenguin = this.physics.add.sprite(200,this.cameras.main.height-55, 'bubblePenguin').setScale(1/6);
            bubblePenguin.body.velocity.set(800, 0);
            bubblePenguin.body.bounce.set(1);
            bubblePenguin.setInteractive();
            bubblePenguin.enableBody=true;

            this.physics.add.collider(bubblePenguin, rainbow1); // 충돌 가능하게
            this.physics.add.collider(bubblePenguin, rainbow2);

            bubblePenguin.on('pointerdown', function(){// 버블펭귄 클릭했을 때
                if(gameState === 1){
                jumpPenguin= this.physics.add.sprite(bubblePenguin.x, bubblePenguin.y, 'jumpPenguin').setScale(1/6);
                jumpPenguin.setVelocityY(-600) .setGravityY(600).setCollideWorldBounds(false);
                jumpPenguin.body.onCollide = true;
                bubblePenguin.setAlpha(0);//투명화

                this.time.addEvent({ //딜레이 주기
                    delay: 1000,
                    callback: ()=>{
                    // 딜레이 후 행동
                    this.physics.add.collider(jumpPenguin, dummyPenguin);
                    jumpPenguin.setCollideWorldBounds(false);
                    //jumpPenguin.setTint(0xf500ff3600); 색 바꾸기
                    },
                })}
            }, this);
        
            this.physics.world.on('collide', (gameObject1, gameObject2) =>
            {
                //충돌시 발생
                dummyPenguin = this.physics.add.sprite(jumpPenguin.x, jumpPenguin.y, 'dummyPenguin').setScale(1/6).setImmovable();
                jumpPenguin.destroy();
                bubblePenguin.setAlpha(1);
                cam.scrollY -= 100;
                scoreText.y = cam.scrollY + 16;
                this.textSecond.y = cam.scrollY + 16;
                this.textGameOver.y = cam.scrollY + 250;
                bubblePenguin.y = cam.scrollY + 545;
                rainbowContainer.y = cam.scrollY + 300;
                score += 10;
                scoreText.setText('Score: ' + score);
            });
            //스코어
            scoreText = this.add.text(50, 16, 'score : 0', { font: '32px Arial', fill: '#000' });

            //시간
            second = 10;
            gameState = 0;
            this.textSecond = this.add.text(300,16,"Time : " + second + "초", { font: '32px Arial', fill: '#000'});
            this.time.addEvent({
        	delay: 1000, // 시간 단위 ms
        	callback: () => {// delay 주기마다 수행할 로직
                if(gameState === 1){
                    second--;
                    if(second === 0){
                        gameState =2;
                    }
                }
            },
        	callbackScope: this, // callback 범위
        	loop: true, // 반복 여부
            });

            //게임 준비 텍스트 출력
            this.textReady = this.add
            .text(400,300, "Press space to start",{ font: '25px Arial', fill: '#000'})
            .setOrigin(.5);

            //게임 오버 텍스트 출력
            this.textGameOver = this.add
            .text(400,250, "Game Over",{ font: '32px Arial', fill: '#000'})
            .setOrigin(.5);
            this.textGameOver.visible = false;

            // if(this.cursorKeys.space.isDown){
            //         this.gameState = 1;
            //         this.textReady.visible = false;
            //     } 

		    this.controls = new Phaser.Cameras.Controls.SmoothedKeyControl({
			camera: this.cameras.main,
			up: cursors.up,
			down: cursors.down,
			acceleration: 0.06,
			maxSpeed: .5
		    });

                const cam = this.cameras.main

                const gui = new dat.GUI();

                const help = {
                line1: 'Cursors to move'
                //line2: 'Q & E to zoom'
                }

                const f1 = gui.addFolder('Camera')
                 f1.add(cam, 'y').listen();
                 f1.add(cam, 'scrollY').listen();
                 f1.open();
        }

        update(time, deltaTime)
        {
            
        	this.controls.update(deltaTime);
            var { scrollX, scrollY } = this.cameras.main;
            this.sky.setTilePosition(scrollX, scrollY);
            this.textSecond.setText("Time : " + second + "초");
            
            if(gameState === 0){
                if (cursors.space.isDown)
                {
                    gameState = 1;
                    this.textReady.visible = false;
                }
                return;
            }else if ( gameState === 2){
                this.textGameOver.visible = true; 
            }
            return;
            //if(gameState ===0){
                
               // return;
           // } else if(this.gameState === 2) {
            //    return;
           // }
        }
        
        }
        const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: 'phaser-example',
        physics: {
            default: 'arcade',
            arcade: { debug: false }
        },
        // scale: {
        // mode: Phaser.Scale.ScaleModes.FIT
        // },
        scene: Example
        };
        
        var cursors;
        var gameState; //0은 게임 준비, 1은 플레이, 2는 게임오버
        var second;
        var textSecond;
        var dummyPenguin;
        var bubblePenguin;
        var jumpPenguin;
        var scoreText
        var score = 0;
        var gameOver = false;
        
        const game = new Phaser.Game(config);
    </script>
</body>
</html>